services:
  app:
    build:
      context: ./ProjektGrupowy.API
      dockerfile: Dockerfile
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80

      - ConnectionStrings__DefaultConnection=Host=host.docker.internal;Database=vidmark;Username=vidmark1yuser;Password=QW7Eb2r6QRhTk;Port=5432
      - ConnectionStrings__HangfireConnection=Host=host.docker.internal;Database=vidmark;Username=vidmark1yuser;Password=QW7Eb2r6QRhTk;Port=5432

      - Logging__LogLevel__Default=Information
      - Logging__LogLevel__Microsoft.AspNetCore=Warning

      - JWT__ValidIssuer=https://api.vidmark.affectivese.org/
      - JWT__ValidAudience=https://vidmark.affectivese.org/
      - JWT__Secret=YourSuperSecretKeyThatIsAtLeast16CharactersLong
      - JWT__JwtCookieName=AuthToken
      - JWT__RefreshCookieName=RefreshToken
      - JWT__ScientistCreateToken=EH2F3j6xu4HKgE
      - JWT__RegularTokenExpiresInMinutes=15
      - JWT__RefreshTokenExpiresInDays=7

      - Videos__RootDirectory=videos
      - Videos__NginxUrl=https://nginx.vidmark.affectivese.org/videos

      - Reports__RootDirectory=reports
      - Reports__NginxUrl=https://nginx.vidmark.affectivese.org/reports

      - Cors__AllowedDevOrigin=https://vidmark.affectivese.org
      - Cors__AllowedProductionOrigin=https://vidmark.affectivese.org

      - SignalR__HubUrl=/hub/app

      - Limits__MaxBodySizeMb=100
    ports:
      - "18130:80"
    networks:
      - mynetwork
    volumes:
      - videos_data:/app/videos
      - reports_data:/app/reports

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_BASE_URL: https://api.vidmark.affectivese.org/api
        VITE_SIGNALR_HUB_URL: https://api.vidmark.affectivese.org/hub/app
    ports:
      - "18131:80"
    networks:
      - mynetwork
    depends_on:
      - app

  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    environment:
      - NGINX_HOST=nginx.vidmark.affectivese.org
      - NGINX_PORT=80
    ports:
      - "18132:80"
    networks:
      - mynetwork
    volumes:
      - videos_data:/mnt/videos:ro
      - reports_data:/mnt/reports:ro

volumes:
  videos_data:
  reports_data:
networks:
  mynetwork:
    driver: bridge
