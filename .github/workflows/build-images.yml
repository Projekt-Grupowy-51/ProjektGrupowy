name: Build Container Images

on:
  workflow_dispatch:
    inputs:
      images:
        description: 'Images to build (comma-separated: backend,frontend,keycloak,nginx,gateway,prometheus,loki,grafana,all)'
        required: true
        default: 'all'
        type: string
      tag:
        description: 'Additional tag (e.g., v1.2.3)'
        required: false
        type: string
  push:
    tags:
      - 'v*.*.*'

env:
  REGISTRY: ghcr.io
  ORG: projekt-grupowy-51

jobs:
  prepare:
    name: Prepare Build Matrix
    runs-on: ubuntu-latest
    outputs:
      build-backend: ${{ steps.determine.outputs.build-backend }}
      build-frontend: ${{ steps.determine.outputs.build-frontend }}
      build-keycloak: ${{ steps.determine.outputs.build-keycloak }}
      build-nginx: ${{ steps.determine.outputs.build-nginx }}
      build-gateway: ${{ steps.determine.outputs.build-gateway }}
      build-prometheus: ${{ steps.determine.outputs.build-prometheus }}
      build-loki: ${{ steps.determine.outputs.build-loki }}
      build-grafana: ${{ steps.determine.outputs.build-grafana }}
      git-sha: ${{ steps.vars.outputs.git-sha }}
      custom-tag: ${{ steps.vars.outputs.custom-tag }}
    steps:
      - name: Set output variables
        id: vars
        run: |
          echo "git-sha=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
          echo "custom-tag=${{ inputs.tag || '' }}" >> $GITHUB_OUTPUT

      - name: Determine images to build
        id: determine
        run: |
          IMAGES="${{ inputs.images }}"

          if [[ "$IMAGES" == "all" ]]; then
            echo "build-backend=true" >> $GITHUB_OUTPUT
            echo "build-frontend=true" >> $GITHUB_OUTPUT
            echo "build-keycloak=true" >> $GITHUB_OUTPUT
            echo "build-nginx=true" >> $GITHUB_OUTPUT
            echo "build-gateway=true" >> $GITHUB_OUTPUT
            echo "build-prometheus=true" >> $GITHUB_OUTPUT
            echo "build-loki=true" >> $GITHUB_OUTPUT
            echo "build-grafana=true" >> $GITHUB_OUTPUT
          else
            echo "build-backend=$(echo $IMAGES | grep -q 'backend' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
            echo "build-frontend=$(echo $IMAGES | grep -q 'frontend' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
            echo "build-keycloak=$(echo $IMAGES | grep -q 'keycloak' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
            echo "build-nginx=$(echo $IMAGES | grep -q 'nginx' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
            echo "build-gateway=$(echo $IMAGES | grep -q 'gateway' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
            echo "build-prometheus=$(echo $IMAGES | grep -q 'prometheus' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
            echo "build-loki=$(echo $IMAGES | grep -q 'loki' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
            echo "build-grafana=$(echo $IMAGES | grep -q 'grafana' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          fi

  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.build-backend == 'true'
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push backend image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: VidMark.API/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.ORG }}/vidmark-backend:latest
            ${{ env.REGISTRY }}/${{ env.ORG }}/vidmark-backend:sha-${{ needs.prepare.outputs.git-sha }}
            ${{ needs.prepare.outputs.custom-tag != '' && format('{0}/{1}/vidmark-backend:{2}', env.REGISTRY, env.ORG, needs.prepare.outputs.custom-tag) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Output image info
        run: |
          echo "Image digest: ${{ steps.build.outputs.digest }}"
          echo "Tags: latest, sha-${{ needs.prepare.outputs.git-sha }}${{ needs.prepare.outputs.custom-tag != '' && format(', {0}', needs.prepare.outputs.custom-tag) || '' }}"

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.build-frontend == 'true'
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push frontend image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./frontend-new
          file: ./frontend-new/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.ORG }}/vidmark-frontend:latest
            ${{ env.REGISTRY }}/${{ env.ORG }}/vidmark-frontend:sha-${{ needs.prepare.outputs.git-sha }}
            ${{ needs.prepare.outputs.custom-tag != '' && format('{0}/{1}/vidmark-frontend:{2}', env.REGISTRY, env.ORG, needs.prepare.outputs.custom-tag) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-keycloak:
    name: Build Keycloak
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.build-keycloak == 'true'
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push keycloak image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./keycloak
          file: ./keycloak/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.ORG }}/vidmark-keycloak:latest
            ${{ env.REGISTRY }}/${{ env.ORG }}/vidmark-keycloak:sha-${{ needs.prepare.outputs.git-sha }}
            ${{ needs.prepare.outputs.custom-tag != '' && format('{0}/{1}/vidmark-keycloak:{2}', env.REGISTRY, env.ORG, needs.prepare.outputs.custom-tag) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-nginx:
    name: Build Nginx
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.build-nginx == 'true'
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push nginx image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./nginx
          file: ./nginx/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.ORG }}/vidmark-nginx:latest
            ${{ env.REGISTRY }}/${{ env.ORG }}/vidmark-nginx:sha-${{ needs.prepare.outputs.git-sha }}
            ${{ needs.prepare.outputs.custom-tag != '' && format('{0}/{1}/vidmark-nginx:{2}', env.REGISTRY, env.ORG, needs.prepare.outputs.custom-tag) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-gateway:
    name: Build Gateway
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.build-gateway == 'true'
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push gateway image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./nginx-gateway
          file: ./nginx-gateway/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.ORG }}/vidmark-gateway:latest
            ${{ env.REGISTRY }}/${{ env.ORG }}/vidmark-gateway:sha-${{ needs.prepare.outputs.git-sha }}
            ${{ needs.prepare.outputs.custom-tag != '' && format('{0}/{1}/vidmark-gateway:{2}', env.REGISTRY, env.ORG, needs.prepare.outputs.custom-tag) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-prometheus:
    name: Build Prometheus
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.build-prometheus == 'true'
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push prometheus image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./prometheus
          file: ./prometheus/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.ORG }}/vidmark-prometheus:latest
            ${{ env.REGISTRY }}/${{ env.ORG }}/vidmark-prometheus:sha-${{ needs.prepare.outputs.git-sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-loki:
    name: Build Loki
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.build-loki == 'true'
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push loki image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./loki
          file: ./loki/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.ORG }}/vidmark-loki:latest
            ${{ env.REGISTRY }}/${{ env.ORG }}/vidmark-loki:sha-${{ needs.prepare.outputs.git-sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-grafana:
    name: Build Grafana
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.build-grafana == 'true'
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push grafana image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./grafana
          file: ./grafana/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.ORG }}/vidmark-grafana:latest
            ${{ env.REGISTRY }}/${{ env.ORG }}/vidmark-grafana:sha-${{ needs.prepare.outputs.git-sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  create-manifest:
    name: Create Build Manifest
    runs-on: ubuntu-latest
    needs: [prepare, build-backend, build-frontend, build-keycloak, build-nginx, build-gateway, build-prometheus, build-loki, build-grafana]
    if: always()
    steps:
      - name: Generate build manifest
        run: |
          cat << EOF > build-manifest.json
          {
            "build_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "git_sha": "${{ needs.prepare.outputs.git-sha }}",
            "git_ref": "${{ github.ref }}",
            "custom_tag": "${{ needs.prepare.outputs.custom-tag }}",
            "images": {
              "backend": {
                "built": "${{ needs.prepare.outputs.build-backend }}",
                "digest": "${{ needs.build-backend.outputs.image-digest || 'n/a' }}"
              },
              "frontend": {
                "built": "${{ needs.prepare.outputs.build-frontend }}",
                "digest": "${{ needs.build-frontend.outputs.image-digest || 'n/a' }}"
              },
              "keycloak": {
                "built": "${{ needs.prepare.outputs.build-keycloak }}",
                "digest": "${{ needs.build-keycloak.outputs.image-digest || 'n/a' }}"
              },
              "nginx": {
                "built": "${{ needs.prepare.outputs.build-nginx }}",
                "digest": "${{ needs.build-nginx.outputs.image-digest || 'n/a' }}"
              },
              "gateway": {
                "built": "${{ needs.prepare.outputs.build-gateway }}",
                "digest": "${{ needs.build-gateway.outputs.image-digest || 'n/a' }}"
              },
              "prometheus": {
                "built": "${{ needs.prepare.outputs.build-prometheus }}",
                "digest": "${{ needs.build-prometheus.outputs.image-digest || 'n/a' }}"
              },
              "loki": {
                "built": "${{ needs.prepare.outputs.build-loki }}",
                "digest": "${{ needs.build-loki.outputs.image-digest || 'n/a' }}"
              },
              "grafana": {
                "built": "${{ needs.prepare.outputs.build-grafana }}",
                "digest": "${{ needs.build-grafana.outputs.image-digest || 'n/a' }}"
              }
            }
          }
          EOF

          cat build-manifest.json

      - name: Upload build manifest
        uses: actions/upload-artifact@v4
        with:
          name: build-manifest
          path: build-manifest.json
          retention-days: 90
