name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      backend_tag:
        description: 'Backend image tag'
        required: true
        default: 'latest'
        type: string
      frontend_tag:
        description: 'Frontend image tag'
        required: true
        default: 'latest'
        type: string
      keycloak_tag:
        description: 'Keycloak image tag'
        required: true
        default: 'latest'
        type: string
      nginx_tag:
        description: 'Nginx image tag'
        required: true
        default: 'latest'
        type: string
      gateway_tag:
        description: 'Gateway image tag'
        required: true
        default: 'latest'
        type: string
      enable_monitoring:
        description: 'Enable monitoring stack (Prometheus, Grafana, Loki)'
        required: true
        type: boolean
        default: false

permissions:
  contents: read
  packages: read

env:
  DEPLOY_DIR: /home/vidmark/vidmark-deploy
  REGISTRY: ghcr.io
  ORG: projekt-grupowy-51

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install SSH tools
        run: sudo apt-get update && sudo apt-get install -y sshpass jq

      - name: Ensure deployment directory exists
        run: |
          sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "mkdir -p ${{ env.DEPLOY_DIR }}"

      - name: Backup current deployment
        run: |
          sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
          cd ${{ env.DEPLOY_DIR }}

          # Backup docker-compose.yml
          if [ -f docker-compose.prod.yml ]; then
            cp docker-compose.prod.yml docker-compose.prod.yml.backup
            echo "Backed up docker-compose.prod.yml"
          fi

          # Backup .env
          if [ -f .env ]; then
            cp .env .env.backup
            echo "Backed up .env"
          fi

          # Save current image tags
          if [ -f docker-compose.prod.yml ]; then
            docker compose -f docker-compose.prod.yml ps --format json 2>/dev/null | \
              jq -r '.Image' > deployed-images.txt.backup || true
            echo "Saved current image list"
          fi

          echo "Backup completed successfully"
          EOF

      - name: Generate .env file
        run: |
          cat << 'ENVEOF' > .env
          # Domain Configuration
          DOMAIN=${{ secrets.DOMAIN }}

          # Image Tags
          BACKEND_TAG=${{ inputs.backend_tag }}
          FRONTEND_TAG=${{ inputs.frontend_tag }}
          KEYCLOAK_TAG=${{ inputs.keycloak_tag }}
          NGINX_TAG=${{ inputs.nginx_tag }}
          GATEWAY_TAG=${{ inputs.gateway_tag }}
          PROMETHEUS_TAG=latest
          LOKI_TAG=latest
          GRAFANA_TAG=latest

          # Database Configuration
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASS=${{ secrets.POSTGRES_PASS }}
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}

          # Keycloak Configuration
          KEYCLOAK_ADMIN=${{ secrets.KEYCLOAK_ADMIN }}
          KEYCLOAK_ADMIN_PASSWORD=${{ secrets.KEYCLOAK_ADMIN_PASSWORD }}
          SCIENTIST_ACCESS_CODE=${{ secrets.SCIENTIST_ACCESS_CODE }}

          # Nginx Configuration
          NGINX_HOST=${{ secrets.NGINX_HOST }}
          NGINX_SECURELINK_SECRET=${{ secrets.NGINX_SECURELINK_SECRET }}

          # Monitoring Configuration
          LOKI_URL=${{ inputs.enable_monitoring == true && 'http://loki:3100' || '' }}

          # Grafana Configuration
          GRAFANA_ADMIN_USER=${{ secrets.GRAFANA_ADMIN_USER }}
          GRAFANA_ADMIN_PASSWORD=${{ secrets.GRAFANA_ADMIN_PASSWORD }}
          ENVEOF

      - name: Upload docker-compose.prod.yml to VPS
        run: |
          sshpass -p "${{ secrets.VPS_PASSWORD }}" scp -o StrictHostKeyChecking=no \
            docker-compose.prod.yml \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ env.DEPLOY_DIR }}/docker-compose.prod.yml

      - name: Upload .env to VPS
        run: |
          sshpass -p "${{ secrets.VPS_PASSWORD }}" scp -o StrictHostKeyChecking=no \
            .env \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ env.DEPLOY_DIR }}/.env

      - name: Pull images and deploy
        env:
          ENABLE_MONITORING: ${{ inputs.enable_monitoring }}
        run: |
          sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
          set -e

          cd ${{ env.DEPLOY_DIR }}

          # Login to GitHub Container Registry
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

          # Determine compose command with optional monitoring profile
          COMPOSE_CMD="docker compose -f docker-compose.prod.yml"
          if [ "${{ inputs.enable_monitoring }}" = "true" ]; then
            COMPOSE_CMD="$COMPOSE_CMD --profile monitoring"
          fi

          # Pull images
          echo "Pulling images..."
          $COMPOSE_CMD pull

          # Deploy services
          echo "Deploying services..."
          $COMPOSE_CMD up -d --remove-orphans

          echo "Deployment initiated successfully"
          EOF

      - name: Validate deployment
        if: success()
        run: |
          sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
          cd ${{ env.DEPLOY_DIR }}

          echo "Deployment validation successful!"
          echo "Deployed services:"
          docker compose -f docker-compose.prod.yml ps
          EOF

      - name: Cleanup secrets
        if: always()
        run: |
          # Remove local .env file
          rm -f .env

          # Remove .env from VPS (keep backup for manual recovery)
          sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "cd ${{ env.DEPLOY_DIR }} && rm -f .env" || true

      - name: Deployment summary
        if: always()
        run: |
          echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Backend Tag:** ${{ inputs.backend_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend Tag:** ${{ inputs.frontend_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Keycloak Tag:** ${{ inputs.keycloak_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Nginx Tag:** ${{ inputs.nginx_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Gateway Tag:** ${{ inputs.gateway_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Monitoring Enabled:** ${{ inputs.enable_monitoring }}" >> $GITHUB_STEP_SUMMARY
